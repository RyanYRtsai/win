<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>TQQQ LRS ç­–ç•¥å„€è¡¨æ¿ï¼ˆFinnhubï¼‰</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;color:#333}
    .container{max-width:1400px;margin:0 auto;padding:20px}
    .header{text-align:center;margin-bottom:30px;color:white}
    .header h1{font-size:2.5rem;margin-bottom:10px;text-shadow:2px 2px 4px rgba(0,0,0,.3)}
    .last-updated{background:rgba(255,255,255,.2);padding:8px 16px;border-radius:20px;display:inline-block;backdrop-filter:blur(10px)}
    .dashboard{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:20px;margin-bottom:30px}
    .card{background:rgba(255,255,255,.95);border-radius:16px;padding:24px;box-shadow:0 8px 32px rgba(0,0,0,.1);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.2);transition:transform .3s ease,box-shadow .3s ease}
    .card:hover{transform:translateY(-4px);box-shadow:0 12px 40px rgba(0,0,0,.15)}
    .card-title{font-size:1.2rem;font-weight:600;margin-bottom:16px;color:#2d3748;display:flex;align-items:center;gap:8px}
    .signal-card{text-align:center;position:relative;overflow:hidden}
    .signal-status{font-size:3rem;font-weight:bold;margin:20px 0;text-shadow:2px 2px 4px rgba(0,0,0,.1)}
    .signal-tqqq{color:#22c55e;animation:pulse 2s ease-in-out infinite}
    .signal-cash{color:#ef4444}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.7}}
    .signal-description{font-size:1.1rem;color:#64748b;margin-bottom:16px}
    .action-required{background:linear-gradient(135deg,#fbbf24,#f59e0b);color:#fff;padding:12px 24px;border-radius:8px;font-weight:600;font-size:1.1rem;animation:glow 2s ease-in-out infinite alternate}
    @keyframes glow{from{box-shadow:0 0 20px rgba(251,191,36,.4)}to{box-shadow:0 0 30px rgba(251,191,36,.8)}}
    .metric{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid #e2e8f0}
    .metric:last-child{border-bottom:none}
    .metric-label{color:#64748b;font-size:.9rem}
    .metric-value{font-weight:600;font-size:1.1rem}
    .positive{color:#22c55e}
    .negative{color:#ef4444}
    .chart-container{grid-column:1 / -1;height:400px}
    .loading{text-align:center;color:white;font-size:1.2rem;margin:40px 0}
    .loading::after{content:'...';animation:dots 1.5s steps(4,end) infinite}
    @keyframes dots{0%,20%{content:''}40%{content:'.'}60%{content:'..'}80%,100%{content:'...'}}
    .refresh-btn{background:rgba(255,255,255,.2);border:1px solid rgba(255,255,255,.3);color:white;padding:8px 16px;border-radius:8px;cursor:pointer;transition:all .3s ease;backdrop-filter:blur(10px)}
    .refresh-btn:hover{background:rgba(255,255,255,.3);transform:scale(1.05)}
    .alert{background:linear-gradient(135deg,#dc2626,#991b1b);color:#fff;padding:16px;border-radius:8px;margin-bottom:20px;text-align:center;font-weight:600}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:.8rem;margin-left:8px}
    .badge-ok{background:#16a34a;color:white}
    .badge-fail{background:#dc2626;color:white}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“Š TQQQ LRS ç­–ç•¥å„€è¡¨æ¿ï¼ˆFinnhubï¼‰ <span id="wsHealth" class="badge">WS æª¢æ¸¬ä¸­</span></h1>
      <div class="last-updated">
        <span id="lastUpdate">è¼‰å…¥ä¸­...</span>
        <button class="refresh-btn" onclick="refreshData()">ğŸ”„ æ›´æ–°(æ—¥ç·š)</button>
      </div>
    </div>

    <div id="loadingIndicator" class="loading"> æ­£åœ¨è¼‰å…¥å¸‚å ´æ•¸æ“š </div>
    <div id="errorAlert" class="alert" style="display:none;">âš ï¸ ç„¡æ³•è¼‰å…¥æ•¸æ“šï¼Œè«‹æª¢æŸ¥é‡‘é‘°æˆ–ç¨å¾Œé‡è©¦</div>

    <div id="dashboardContent" class="dashboard" style="display:none;">
      <div class="card signal-card">
        <h2 class="card-title">ğŸ¯ ç•¶å‰ç­–ç•¥ä¿¡è™Ÿ</h2>
        <div id="signalStatus" class="signal-status">è¼‰å…¥ä¸­...</div>
        <div id="signalDescription" class="signal-description">åˆ†æä¸­...</div>
        <div id="actionRequired" class="action-required" style="display:none;">éœ€è¦èª¿æ•´å€‰ä½ï¼</div>
      </div>

      <div class="card">
        <h2 class="card-title">ğŸ“ˆ QQQ åƒ¹æ ¼è³‡è¨Š</h2>
        <div class="metric"><span class="metric-label">ç•¶å‰åƒ¹æ ¼</span><span id="qqqPrice" class="metric-value">$--</span></div>
        <div class="metric"><span class="metric-label">200æ—¥å‡ç·š</span><span id="qqqSma200" class="metric-value">$--</span></div>
        <div class="metric"><span class="metric-label">è·é›¢å‡ç·š</span><span id="qqqDistance" class="metric-value">--%</span></div>
        <div class="metric"><span class="metric-label">æ—¥è®ŠåŒ–</span><span id="qqqChange" class="metric-value">--%</span></div>
      </div>

      <div class="card">
        <h2 class="card-title">ğŸš€ TQQQ åƒ¹æ ¼è³‡è¨Š</h2>
        <div class="metric"><span class="metric-label">ç•¶å‰åƒ¹æ ¼</span><span id="tqqqPrice" class="metric-value">$--</span></div>
        <div class="metric"><span class="metric-label">æ—¥è®ŠåŒ–</span><span id="tqqqChange" class="metric-value">--%</span></div>
        <div class="metric"><span class="metric-label">æ³¢å‹•ç‡ (20æ—¥)</span><span id="tqqqVolatility" class="metric-value">--%</span></div>
        <div class="metric"><span class="metric-label">RSI (14æ—¥)</span><span id="tqqqRsi" class="metric-value">--</span></div>
      </div>

      <div class="card">
        <h2 class="card-title">ğŸ“Š ç­–ç•¥çµ±è¨ˆ</h2>
        <div class="metric"><span class="metric-label">æœ¬æœˆä¿¡è™Ÿè®ŠåŒ–</span><span id="monthlySignals" class="metric-value">-- æ¬¡</span></div>
        <div class="metric"><span class="metric-label">ç›®å‰é€±æœŸå¤©æ•¸</span><span id="currentCycleDays" class="metric-value">-- å¤©</span></div>
        <div class="metric"><span class="metric-label">TQQQ æŒæœ‰æ¯”ä¾‹ (YTD)</span><span id="tqqqHoldingRatio" class="metric-value">--%</span></div>
        <div class="metric"><span class="metric-label">ç­–ç•¥å‹ç‡ (è¿‘30å¤©)</span><span id="winRate" class="metric-value">--%</span></div>
      </div>

      <div class="card">
        <h2 class="card-title">âš ï¸ é¢¨éšªæŒ‡æ¨™</h2>
        <div class="metric"><span class="metric-label">VIX ä»£ç† (VIXY)</span><span id="vixLevel" class="metric-value">--</span></div>
        <div class="metric"><span class="metric-label">å¸‚å ´è¶¨å‹¢å¼·åº¦</span><span id="trendStrength" class="metric-value">--</span></div>
        <div class="metric"><span class="metric-label">å›æ’¤é¢¨éšª</span><span id="drawdownRisk" class="metric-value">--</span></div>
        <div class="metric"><span class="metric-label">ä¿¡è™Ÿç©©å®šæ€§</span><span id="signalStability" class="metric-value">--</span></div>
      </div>

      <div class="card">
        <h2 class="card-title">ğŸ’¡ å»ºè­°è¡Œå‹•</h2>
        <div id="recommendations" style="line-height:1.6;">
          <div class="loading">åˆ†æä¸­...</div>
        </div>
      </div>
    </div>

    <div id="chartSection" style="display:none;">
      <div class="card chart-container">
        <h2 class="card-title">ğŸ“ˆ QQQ åƒ¹æ ¼ vs 200æ—¥å‡ç·š (è¿‘90å¤©)</h2>
        <canvas id="priceChart"></canvas>
      </div>
    </div>
  </div>

  <script>
    // ====== Finnhub è¨­å®š ======
    const FINNHUB_KEY = 'd2ev6o9r01qmrq4p164gd2ev6o9r01qmrq4p1650';
    const FH_BASE = 'https://finnhub.io/api/v1';
    const WS_URL = `wss://ws.finnhub.io?token=${encodeURIComponent(FINNHUB_KEY)}`;

    // REST è«‹æ±‚ï¼ˆå°‘é‡ã€å«å¿«å–ï¼‰
    const LS_PREFIX = 'tqqq_fh_';
    function cacheGet(k){try{const r=localStorage.getItem(LS_PREFIX+k);if(!r)return null;const o=JSON.parse(r);if(o.exp && Date.now()>o.exp){localStorage.removeItem(LS_PREFIX+k);return null}return o.val}catch{return null}}
    function cacheSet(k,v,ttl){localStorage.setItem(LS_PREFIX+k,JSON.stringify({val:v,exp:ttl?Date.now()+ttl:0}))}
    async function fetchJSON(url, cacheKey=null, ttlMs=0){
      if(cacheKey){const c=cacheGet(cacheKey); if(c) return c;}
      const res = await fetch(url);
      if(!res.ok) throw new Error('HTTP '+res.status);
      const j = await res.json();
      if(cacheKey && ttlMs) cacheSet(cacheKey,j,ttlMs);
      return j;
    }

    // ====== æŒ‡æ¨™è¨ˆç®— ======
    function computeSMA(arr, win){ if(arr.length<win) return null; const s=arr.slice(-win).reduce((a,b)=>a+b,0); return s/win }
    function computeRSI(arr, p=14){
      if(arr.length<=p) return null;
      let g=0,l=0;
      for(let i=arr.length-p;i<arr.length;i++){
        const d = arr[i]-arr[i-1];
        if(d>=0) g+=d; else l-=d;
      }
      const rs = l===0 ? 100 : g/l;
      return 100 - (100/(1+rs));
    }
    function computeVol(arr, look=20){
      if(arr.length<look+1) return null;
      const seg = arr.slice(-look-1);
      const rets = [];
      for(let i=1;i<seg.length;i++) rets.push((seg[i]-seg[i-1])/seg[i-1]);
      const m = rets.reduce((a,b)=>a+b,0)/rets.length;
      const v = rets.reduce((a,b)=>a+Math.pow(b-m,2),0)/(rets.length-1);
      return Math.sqrt(v)*Math.sqrt(252)*100;
    }

    // ====== å–æ—¥ç·šï¼šstock/candle ======
    async function getDailyCandles(symbol, days=500){
      const to = Math.floor(Date.now()/1000);
      const from = to - Math.floor(days*24*60*60*1.2); // buffer
      const url = `${FH_BASE}/stock/candle?symbol=${encodeURIComponent(symbol)}&resolution=D&from=${from}&to=${to}&token=${encodeURIComponent(FINNHUB_KEY)}`;
      const j = await fetchJSON(url, `candle_${symbol}`, 24*60*60*1000);
      if(j.s!=='ok') throw new Error('No candle data: '+symbol);
      // Finnhub å›å‚³: t(unixt), c(æ”¶), o,h,l,v
      const dates = j.t.map(ts => new Date(ts*1000).toISOString().slice(0,10));
      const closes = j.c;
      return {dates, closes};
    }

    // ====== å–å¿«ç…§å ±åƒ¹ï¼š/quoteï¼ˆåªç‚ºäº†å‰æ”¶ & åˆå§‹ % è®ŠåŒ–ï¼‰ ======
    async function getQuote(symbol){
      const url = `${FH_BASE}/quote?symbol=${encodeURIComponent(symbol)}&token=${encodeURIComponent(FINNHUB_KEY)}`;
      const j = await fetchJSON(url, `quote_${symbol}`, 10*60*1000); // 10 åˆ†é˜å¿«å–
      // å›å‚³: c=ç¾åƒ¹, dp=è®ŠåŒ–%, pc=å‰æ”¶, t=æ™‚é–“
      return { price:j.c||0, changePct:j.dp||0, prevClose:j.pc||0, ts:j.t? new Date(j.t*1000): new Date() };
    }

    // ====== WebSocket å³æ™‚è¨‚é–± ======
    let ws=null, wsTimer=null, wsBackoff=2000, wsHealthy=false;
    const subs = new Set(['QQQ','TQQQ']); // éœ€è¦çš„å³æ™‚æ¨™çš„
    const lastPrice = { QQQ: null, TQQQ: null, VIXY: null };
    const prevClose = { QQQ: null, TQQQ: null, VIXY: null };

    function setWSBadge(ok){
      wsHealthy = ok;
      const el = document.getElementById('wsHealth');
      el.textContent = ok ? 'WS é€£ç·šæ­£å¸¸' : 'WS æœªé€£ç·š';
      el.className = 'badge ' + (ok ? 'badge-ok' : 'badge-fail');
    }

    function openWS(){
      try{
        ws = new WebSocket(WS_URL);
      }catch(e){
        setWSBadge(false);
        scheduleReconnect();
        return;
      }
      ws.onopen = ()=>{
        setWSBadge(true);
        wsBackoff = 2000;
        subs.forEach(s => ws.send(JSON.stringify({type:'subscribe', symbol:s})));
      };
      ws.onmessage = (ev)=>{
        const msg = JSON.parse(ev.data);
        if(msg.type==='trade' && Array.isArray(msg.data)){
          msg.data.forEach(t=>{
            const s = t.s;
            const p = t.p;
            if(lastPrice[s]===null || lastPrice[s]!==p){
              lastPrice[s]=p;
              if(s==='QQQ') updateLiveQuoteUI('QQQ', p);
              if(s==='TQQQ') updateLiveQuoteUI('TQQQ', p);
            }
          });
          // æ›´æ–°æ™‚é–“æˆ³
          document.getElementById('lastUpdate').textContent = new Date().toLocaleString('zh-TW');
        }
      };
      ws.onerror = ()=>{ setWSBadge(false); };
      ws.onclose = ()=>{ setWSBadge(false); scheduleReconnect(); };
    }

    function scheduleReconnect(){
      if(wsTimer) clearTimeout(wsTimer);
      wsTimer = setTimeout(()=>openWS(), wsBackoff);
      wsBackoff = Math.min(wsBackoff*1.8, 60000);
    }

    // ====== REST å¾Œå‚™è¼ªè©¢ï¼ˆWS ä¸é€šæ™‚ç”¨ï¼‰ ======
    let pollTimer=null;
    function startPollFallback(){
      if(pollTimer) return;
      pollTimer = setInterval(async ()=>{
        try{
          const [q1, q2] = await Promise.all([getQuote('QQQ'), getQuote('TQQQ')]);
          lastPrice.QQQ = q1.price; lastPrice.TQQQ = q2.price;
          updateLiveQuoteUI('QQQ', q1.price, q1.prevClose);
          updateLiveQuoteUI('TQQQ', q2.price, q2.prevClose);
          document.getElementById('lastUpdate').textContent = new Date().toLocaleString('zh-TW');
        }catch(e){ /* éœé»˜å¤±æ•— */ }
      }, 60*1000); // æ¯ 5 åˆ†é˜
    }
    function stopPollFallback(){
      if(pollTimer){ clearInterval(pollTimer); pollTimer=null; }
    }

    // ====== UI æ›´æ–°ï¼ˆå³æ™‚æ•¸å­—ï¼‰ ======
    function updateLiveQuoteUI(symbol, price, givenPrevClose){
      const pc = givenPrevClose ?? prevClose[symbol] ?? null;
      if(symbol==='QQQ'){
        document.getElementById('qqqPrice').textContent = '$' + (price?.toFixed(2) ?? '--');
        if(pc){
          const chg = ((price-pc)/pc*100);
          document.getElementById('qqqChange').textContent = (isFinite(chg)? chg.toFixed(2): '--') + '%';
          document.getElementById('qqqChange').className = 'metric-value ' + (chg>=0?'positive':'negative');
        }
      }
      if(symbol==='TQQQ'){
        document.getElementById('tqqqPrice').textContent = '$' + (price?.toFixed(2) ?? '--');
        const pc2 = prevClose.TQQQ;
        if(pc2){
          const chg2 = ((price-pc2)/pc2*100);
          document.getElementById('tqqqChange').textContent = (isFinite(chg2)? chg2.toFixed(2): '--') + '%';
          document.getElementById('tqqqChange').className = 'metric-value ' + (chg2>=0?'positive':'negative');
        }
      }
    }

    // ====== ä¸»æµç¨‹ï¼šæŠ“æ—¥ç·šã€ç®—æŒ‡æ¨™ã€ç•«åœ– ======
    let chartInstance=null;

    async function fetchMarketData(){
      // å…ˆæŠ“ quote æ‹¿ prevCloseï¼Œä¾¿æ–¼è¨ˆç®—è®ŠåŒ– %
      const [qQQQ, qTQQQ, qVIXY] = await Promise.all([ getQuote('QQQ'), getQuote('TQQQ'), getQuote('VIXY') ]);
      prevClose.QQQ = qQQQ.prevClose; prevClose.TQQQ = qTQQQ.prevClose; prevClose.VIXY = qVIXY.prevClose;

      // æ—¥ç·š
      const [dQQQ, dTQQQ] = await Promise.all([ getDailyCandles('QQQ', 500), getDailyCandles('TQQQ', 500) ]);

      const qqqSMA200 = computeSMA(dQQQ.closes, 200);
      const tVol = computeVol(dTQQQ.closes, 20);
      const tRSI = computeRSI(dTQQQ.closes, 14);

      // è¿‘ 90 å¤©åœ–è¡¨
      const hist = [];
      const n = Math.min(90, dQQQ.dates.length);
      for(let i=dQQQ.dates.length - n; i<dQQQ.dates.length; i++){
        const slice = dQQQ.closes.slice(0, i+1);
        const sma = computeSMA(slice, 200);
        hist.push({ date: dQQQ.dates[i], price: dQQQ.closes[i], sma200: sma });
      }

      // ç•¶å‰åƒ¹æ ¼ï¼ˆå…ˆç”¨ quoteï¼Œä¹‹å¾Œç”± WS å³æ™‚è¦†è“‹ï¼‰
      lastPrice.QQQ = qQQQ.price || dQQQ.closes.at(-1);
      lastPrice.TQQQ = qTQQQ.price || dTQQQ.closes.at(-1);

      // LRS è¨Šè™Ÿ
      const isAbove = qqqSMA200 ? lastPrice.QQQ > qqqSMA200 : null;
      const distance = qqqSMA200 ? ((lastPrice.QQQ - qqqSMA200)/qqqSMA200*100) : null;

      // ç­–ç•¥çµ±è¨ˆ
      let monthlySignals = 0, holdingCount = 0;
      for(let i=1;i<hist.length;i++){
        const a=hist[i-1], b=hist[i];
        if(a.sma200 && b.sma200){
          const pa = a.price>a.sma200, pb = b.price>b.sma200;
          if(pa!==pb) monthlySignals++;
          if(pb) holdingCount++;
        }
      }
      let streak=1;
      for(let i=hist.length-2;i>=0;i--){
        const a=hist[i], b=hist[i+1];
        if(a.sma200 && b.sma200 && (a.price>a.sma200)===(b.price>b.sma200)) streak++;
        else break;
      }

      const data = {
        lastUpdate: new Date().toLocaleString('zh-TW'),
        qqq:{
          price: (lastPrice.QQQ||0).toFixed(2),
          change: qQQQ.changePct?.toFixed?.(2) ?? '--',
          sma200: qqqSMA200? qqqSMA200.toFixed(2): '--',
          distance: qqqSMA200? distance.toFixed(2): '--',
          isAboveSma: !!isAbove
        },
        tqqq:{
          price: (lastPrice.TQQQ||0).toFixed(2),
          change: qTQQQ.changePct?.toFixed?.(2) ?? '--',
          volatility: tVol? tVol.toFixed(1): '--',
          rsi: tRSI? tRSI.toFixed(0): '--'
        },
        risk:{
          vix: qVIXY.price? qVIXY.price.toFixed(1): '--', // ä»¥ VIXY è¿‘ä¼¼
          trendStrength: (qqqSMA200 && Math.abs(distance)>5)? 'å¼·':'å¼±',
          drawdownRisk: qVIXY.price? (qVIXY.price>30? 'é«˜': qVIXY.price>20? 'ä¸­':'ä½'): '--',
          signalStability: monthlySignals<2? 'ç©©å®š':'ä¸ç©©å®š'
        },
        strategy:{
          signal: isAbove? 'TQQQ':'CASH',
          monthlySignals,
          currentCycleDays: streak,
          holdingRatio: hist.length? ((holdingCount/hist.length)*100).toFixed(0): '--',
          winRate: '--'
        },
        historicalData: hist
      };
      return data;
    }

    function updateDashboard(data){
      // Header
      document.getElementById('lastUpdate').textContent = data.lastUpdate;

      // Signal
      const isTQQQ = data.strategy.signal==='TQQQ';
      const signalEl = document.getElementById('signalStatus');
      signalEl.className='signal-status ' + (isTQQQ? 'signal-tqqq':'signal-cash');
      signalEl.textContent = isTQQQ? 'æŒæœ‰ TQQQ':'æŒæœ‰ ç¾é‡‘è…¿';
      document.getElementById('signalDescription').textContent = isTQQQ? 'QQQ æ”¶ç›¤ > SMA200ï¼Œå•Ÿç”¨æ§“æ¡¿è…¿':'QQQ æ”¶ç›¤ â‰¤ SMA200ï¼Œè½‰å…¥ç¾é‡‘è…¿';
      document.getElementById('actionRequired').style.display='none';

      // QQQ
      document.getElementById('qqqPrice').textContent = '$'+data.qqq.price;
      document.getElementById('qqqSma200').textContent = data.qqq.sma200==='--'?'--':('$'+data.qqq.sma200);
      document.getElementById('qqqDistance').textContent = data.qqq.distance==='--'?'--':(data.qqq.distance+'%');
      document.getElementById('qqqChange').textContent = (data.qqq.change||'0')+'%';
      document.getElementById('qqqChange').className = 'metric-value ' + ((parseFloat(data.qqq.change)||0)>=0?'positive':'negative');

      // TQQQ
      document.getElementById('tqqqPrice').textContent = '$'+data.tqqq.price;
      document.getElementById('tqqqChange').textContent = (data.tqqq.change||'0')+'%';
      document.getElementById('tqqqChange').className = 'metric-value ' + ((parseFloat(data.tqqq.change)||0)>=0?'positive':'negative');
      document.getElementById('tqqqVolatility').textContent = data.tqqq.volatility==='--'?'--':(data.tqqq.volatility+'%');
      document.getElementById('tqqqRsi').textContent = data.tqqq.rsi;

      // Risk
      document.getElementById('vixLevel').textContent = data.risk.vix;
      document.getElementById('trendStrength').textContent = data.risk.trendStrength;
      document.getElementById('drawdownRisk').textContent = data.risk.drawdownRisk;
      document.getElementById('signalStability').textContent = data.risk.signalStability;

      // Strategy stats
      document.getElementById('monthlySignals').textContent = data.strategy.monthlySignals+' æ¬¡';
      document.getElementById('currentCycleDays').textContent = data.strategy.currentCycleDays+' å¤©';
      document.getElementById('tqqqHoldingRatio').textContent = data.strategy.holdingRatio+'%';
      document.getElementById('winRate').textContent = data.strategy.winRate;

      // Chart
      const ctx = document.getElementById('priceChart').getContext('2d');
      const labels = data.historicalData.map(d=>d.date);
      const priceSeries = data.historicalData.map(d=>d.price);
      const smaSeries = data.historicalData.map(d=>d.sma200);
      if(chartInstance) chartInstance.destroy();
      chartInstance = new Chart(ctx,{
        type:'line',
        data:{labels,datasets:[
          {label:'QQQ',data:priceSeries,borderWidth:2,fill:false,tension:.2},
          {label:'SMA200',data:smaSeries,borderWidth:2,borderDash:[6,4],fill:false,tension:.2}
        ]},
        options:{responsive:true,plugins:{legend:{display:true}}}
      });

      document.getElementById('loadingIndicator').style.display='none';
      document.getElementById('errorAlert').style.display='none';
      document.getElementById('dashboardContent').style.display='grid';
      document.getElementById('chartSection').style.display='block';
    }

    async function initAll(){
      try{
        // æ—¥ç·šèˆ‡åˆå§‹æ•¸æ“š
        const data = await fetchMarketData();
        updateDashboard(data);

        // å•Ÿå‹• WSï¼ˆè‹¥å¤±æ•—è‡ªå‹•å•Ÿå‹•è¼ªè©¢å¾Œå‚™ï¼‰
        openWS();
        // ç›£çœ‹ WS å¥åº·ï¼Œè‹¥ 10 ç§’å…§æ²’æœ‰é€£ç·šæˆåŠŸå°±å•Ÿå‹•å¾Œå‚™ï¼›è‹¥é€£ä¸Šå‰‡é—œå¾Œå‚™
        setTimeout(()=>{ if(!wsHealthy) startPollFallback(); }, 10000);
        const wsHealthWatcher = setInterval(()=>{ if(wsHealthy) stopPollFallback(); else startPollFallback(); }, 15000);

      }catch(err){
        console.error(err);
        document.getElementById('loadingIndicator').style.display='none';
        document.getElementById('errorAlert').style.display='block';
      }
    }

    async function refreshData(){ // åªåˆ·æ–°æ—¥ç·šèˆ‡è¡ç”ŸæŒ‡æ¨™
      document.getElementById('loadingIndicator').style.display='block';
      document.getElementById('dashboardContent').style.display='none';
      document.getElementById('chartSection').style.display='none';
      try{
        const data = await fetchMarketData();
        updateDashboard(data);
      }catch(err){
        console.error(err);
        document.getElementById('loadingIndicator').style.display='none';
        document.getElementById('errorAlert').style.display='block';
      }
    }

    // é¦–æ¬¡è¼‰å…¥
    initAll();

    // è¦–çª—å›åˆ°å‰æ™¯æ™‚ï¼Œåˆ·æ–°ä¸€æ¬¡
    document.addEventListener('visibilitychange',()=>{ if(!document.hidden) refreshData(); });
  </script>
</body>
</html>
