<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>TQQQ LRS ç­–ç•¥å„€è¡¨æ¿ï¼ˆYahoo Financeï¼‰</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;color:#333}
    .container{max-width:1400px;margin:0 auto;padding:20px;position:relative}
    .header{text-align:center;margin-bottom:30px;color:white;position:relative}
    .header h1{font-size:2.2rem;margin-bottom:10px;text-shadow:2px 2px 4px rgba(0,0,0,.3)}
    .last-updated{background:rgba(255,255,255,.2);padding:8px 16px;border-radius:20px;display:inline-block;backdrop-filter:blur(10px)}
    .header-right{position:absolute;top:0;right:0;display:flex;gap:8px;align-items:center}
    .dashboard{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:20px;margin-bottom:30px}
    .card{background:rgba(255,255,255,.95);border-radius:16px;padding:24px;box-shadow:0 8px 32px rgba(0,0,0,.1);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.2);transition:transform .3s ease,box-shadow .3s ease}
    .card:hover{transform:translateY(-4px);box-shadow:0 12px 40px rgba(0,0,0,.15)}
    .card-title{font-size:1.15rem;font-weight:600;margin-bottom:16px;color:#2d3748;display:flex;align-items:center;gap:8px}
    .signal-card{text-align:center;position:relative;overflow:hidden}
    .signal-status{font-size:2.6rem;font-weight:bold;margin:20px 0;text-shadow:2px 2px 4px rgba(0,0,0,.1)}
    .signal-tqqq{color:#22c55e;animation:pulse 2s ease-in-out infinite}
    .signal-cash{color:#ef4444}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.7}}
    .signal-description{font-size:1.05rem;color:#64748b;margin-bottom:16px}
    .action-required{background:linear-gradient(135deg,#fbbf24,#f59e0b);color:#fff;padding:12px 24px;border-radius:8px;font-weight:600;font-size:1.05rem;animation:glow 2s ease-in-out infinite alternate}
    @keyframes glow{from{box-shadow:0 0 20px rgba(251,191,36,.4)}to{box-shadow:0 0 30px rgba(251,191,36,.8)}}
    .metric{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid #e2e8f0}
    .metric:last-child{border-bottom:none}
    .metric-label{color:#64748b;font-size:.9rem}
    .metric-value{font-weight:600;font-size:1.05rem}
    .positive{color:#22c55e}
    .negative{color:#ef4444}
    .chart-container{grid-column:1 / -1;height:400px}
    .loading{text-align:center;color:white;font-size:1.1rem;margin:40px 0}
    .loading::after{content:'...';animation:dots 1.5s steps(4,end) infinite}
    @keyframes dots{0%,20%{content:''}40%{content:'.'}60%{content:'..'}80%,100%{content:'...'}}
    .btn{background:rgba(255,255,255,.2);border:1px solid rgba(255,255,255,.3);color:white;padding:8px 12px;border-radius:8px;cursor:pointer;transition:all .3s ease;backdrop-filter:blur(10px)}
    .btn:hover{background:rgba(255,255,255,.3);transform:scale(1.05)}
    .alert{background:linear-gradient(135deg,#dc2626,#991b1b);color:#fff;padding:16px;border-radius:8px;margin-bottom:20px;text-align:center;font-weight:600}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:.78rem}
    .badge-ok{background:#16a34a;color:white}
    .badge-fail{background:#dc2626;color:white}
    .muted{opacity:.8}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“Š TQQQ LRS ç­–ç•¥å„€è¡¨æ¿ï¼ˆYahoo Financeï¼‰</h1>
      <div class="last-updated">
        <span id="lastUpdate">è¼‰å…¥ä¸­...</span>
        <button class="btn" onclick="refreshDaily()">ğŸ”„ æ›´æ–°ï¼ˆæ—¥ç·šï¼‰</button>
      </div>
      <div class="header-right">
        <button class="btn" onclick="runHealthCheck()">ğŸ©º å¥åº·æª¢æŸ¥</button>
        <span id="apiHealth" class="badge muted">API æª¢æ¸¬ä¸­</span>
        <span id="wsHealth" class="badge muted" title="æœ¬ç‰ˆæœªå•Ÿç”¨ WS">WS æœªä½¿ç”¨</span>
      </div>
    </div>

    <div id="loadingIndicator" class="loading"> æ­£åœ¨è¼‰å…¥å¸‚å ´æ•¸æ“š </div>
    <div id="errorAlert" class="alert" style="display:none;">âš ï¸ ç„¡æ³•è¼‰å…¥æ•¸æ“šï¼Œè«‹ç¨å¾Œé‡è©¦</div>

    <div id="dashboardContent" class="dashboard" style="display:none;">
      <div class="card signal-card">
        <h2 class="card-title">ğŸ¯ ç•¶å‰ç­–ç•¥ä¿¡è™Ÿ</h2>
        <div id="signalStatus" class="signal-status">è¼‰å…¥ä¸­...</div>
        <div id="signalDescription" class="signal-description">åˆ†æä¸­...</div>
        <div id="actionRequired" class="action-required" style="display:none;">éœ€è¦èª¿æ•´å€‰ä½ï¼</div>
      </div>

      <div class="card">
        <h2 class="card-title">ğŸ“ˆ QQQ åƒ¹æ ¼è³‡è¨Š</h2>
        <div class="metric"><span class="metric-label">ç•¶å‰åƒ¹æ ¼</span><span id="qqqPrice" class="metric-value">$--</span></div>
        <div class="metric"><span class="metric-label">200æ—¥å‡ç·š</span><span id="qqqSma200" class="metric-value">$--</span></div>
        <div class="metric"><span class="metric-label">è·é›¢å‡ç·š</span><span id="qqqDistance" class="metric-value">--%</span></div>
        <div class="metric"><span class="metric-label">æ—¥è®ŠåŒ–</span><span id="qqqChange" class="metric-value">--%</span></div>
      </div>

      <div class="card">
        <h2 class="card-title">ğŸš€ TQQQ åƒ¹æ ¼è³‡è¨Š</h2>
        <div class="metric"><span class="metric-label">ç•¶å‰åƒ¹æ ¼</span><span id="tqqqPrice" class="metric-value">$--</span></div>
        <div class="metric"><span class="metric-label">æ—¥è®ŠåŒ–</span><span id="tqqqChange" class="metric-value">--%</span></div>
        <div class="metric"><span class="metric-label">æ³¢å‹•ç‡ (20æ—¥)</span><span id="tqqqVolatility" class="metric-value">--%</span></div>
        <div class="metric"><span class="metric-label">RSI (14æ—¥)</span><span id="tqqqRsi" class="metric-value">--</span></div>
      </div>

      <div class="card">
        <h2 class="card-title">ğŸ“Š ç­–ç•¥çµ±è¨ˆ</h2>
        <div class="metric"><span class="metric-label">æœ¬æœˆä¿¡è™Ÿè®ŠåŒ–</span><span id="monthlySignals" class="metric-value">-- æ¬¡</span></div>
        <div class="metric"><span class="metric-label">ç›®å‰é€±æœŸå¤©æ•¸</span><span id="currentCycleDays" class="metric-value">-- å¤©</span></div>
        <div class="metric"><span class="metric-label">TQQQ æŒæœ‰æ¯”ä¾‹ (YTD)</span><span id="tqqqHoldingRatio" class="metric-value">--%</span></div>
        <div class="metric"><span class="metric-label">ç­–ç•¥å‹ç‡ (è¿‘30å¤©)</span><span id="winRate" class="metric-value">--%</span></div>
      </div>

      <div class="card">
        <h2 class="card-title">âš ï¸ é¢¨éšªæŒ‡æ¨™</h2>
        <div class="metric"><span class="metric-label">VIX æŒ‡æ•¸</span><span id="vixLevel" class="metric-value">--</span></div>
        <div class="metric"><span class="metric-label">å¸‚å ´è¶¨å‹¢å¼·åº¦</span><span id="trendStrength" class="metric-value">--</span></div>
        <div class="metric"><span class="metric-label">å›æ’¤é¢¨éšª</span><span id="drawdownRisk" class="metric-value">--</span></div>
        <div class="metric"><span class="metric-label">ä¿¡è™Ÿç©©å®šæ€§</span><span id="signalStability" class="metric-value">--</span></div>
      </div>

      <div class="card">
        <h2 class="card-title">ğŸ’¡ å»ºè­°è¡Œå‹•</h2>
        <div id="recommendations" style="line-height:1.6;">
          <div class="loading">åˆ†æä¸­...</div>
        </div>
      </div>
    </div>

    <div id="chartSection" style="display:none;">
      <div class="card chart-container">
        <h2 class="card-title">ğŸ“ˆ QQQ åƒ¹æ ¼ vs 200æ—¥å‡ç·š (è¿‘90å¤©)</h2>
        <canvas id="priceChart"></canvas>
      </div>
    </div>
  </div>

  <script>
    // ===== Yahoo Finance endpoints =====
    const YF_QUOTE = (symbols) => 'https://query1.finance.yahoo.com/v7/finance/quote?symbols=' + encodeURIComponent(symbols.join(','));
    // chart API: range: 1y/2y/5y/max ; interval: 1d/1wk/1mo
    const YF_CHART = (symbol, range='2y', interval='1d') =>
      `https://query1.finance.yahoo.com/v8/finance/chart/${encodeURIComponent(symbol)}?range=${range}&interval=${interval}&events=div%2Csplit&includeAdjustedClose=true`;

    // ===== Quotas & cache (minimize requests) =====
    const QUOTE_POLL_MS   = 3 * 60 * 1000;     // æ¯ 3 åˆ†é˜æŠ“ä¸€æ¬¡ quoteï¼ˆå–®ç­†è«‹æ±‚æ‹¿å¤šæª”ï¼‰
    const QUOTE_CACHE_MS  = 10 * 60 * 1000;    // quote å¿«å– 10 åˆ†é˜ï¼ˆå¥åº·æª¢æŸ¥ä¸èµ°å¿«å–ï¼‰
    const CHART_CACHE_MS  = 24 * 60 * 60 * 1000; // æ—¥ç·šå¿«å– 1 å¤©
    const LS_PREFIX = 'yf_cache_';

    function cacheGet(key){
      try{ const raw = localStorage.getItem(LS_PREFIX+key);
        if(!raw) return null;
        const obj = JSON.parse(raw);
        if(obj.exp && Date.now()>obj.exp){ localStorage.removeItem(LS_PREFIX+key); return null; }
        return obj.val;
      }catch{ return null; }
    }
    function cacheSet(key, val, ttl){
      localStorage.setItem(LS_PREFIX+key, JSON.stringify({ val, exp: ttl? Date.now()+ttl : 0 }));
    }
    async function fetchJSON(url, cacheKey=null, ttl=0){
      if(cacheKey){
        const c = cacheGet(cacheKey);
        if(c) return c;
      }
      const r = await fetch(url, { headers: { 'Accept': 'application/json' }});
      if(!r.ok) throw new Error('HTTP '+r.status);
      const j = await r.json();
      if(cacheKey && ttl) cacheSet(cacheKey, j, ttl);
      return j;
    }

    // ===== Indicators =====
    function sma(arr, n){ if(arr.length<n) return null; const s=arr.slice(-n).reduce((a,b)=>a+b,0); return s/n; }
    function rsi(arr, p=14){
      if(arr.length<=p) return null;
      let g=0,l=0;
      for(let i=arr.length-p;i<arr.length;i++){
        const d = arr[i]-arr[i-1];
        if(d>=0) g+=d; else l-=d;
      }
      const rs = l===0 ? 100 : g/l;
      return 100 - (100/(1+rs));
    }
    function vol(arr, look=20){
      if(arr.length<look+1) return null;
      const seg = arr.slice(-look-1);
      const rets = [];
      for(let i=1;i<seg.length;i++) rets.push((seg[i]-seg[i-1])/seg[i-1]);
      const m = rets.reduce((a,b)=>a+b,0)/rets.length;
      const v = rets.reduce((a,b)=>a+Math.pow(b-m,2),0)/(rets.length-1);
      return Math.sqrt(v)*Math.sqrt(252)*100;
    }

    // ===== Parse Yahoo responses =====
    async function getQuotes(symbols, useCache=true){
      const url = YF_QUOTE(symbols);
      const cacheKey = 'quote_' + symbols.join('_');
      const ttl = useCache ? QUOTE_CACHE_MS : 0;
      const j = await fetchJSON(url, useCache? cacheKey : null, ttl);
      const rows = j.quoteResponse?.result || [];
      const map = {};
      for(const r of rows){
        map[r.symbol] = {
          price: r.regularMarketPrice ?? null,
          changePct: r.regularMarketChangePercent ?? null,
          prevClose: r.regularMarketPreviousClose ?? null,
          time: r.regularMarketTime ? new Date(r.regularMarketTime*1000) : null
        };
      }
      return map;
    }

    async function getDailyCloses(symbol, range='2y'){
      const url = YF_CHART(symbol, range, '1d');
      const cacheKey = `chart_${symbol}_${range}_1d`;
      const j = await fetchJSON(url, cacheKey, CHART_CACHE_MS);
      const res = j.chart?.result?.[0];
      if(!res) throw new Error('No chart data for '+symbol);
      const ts = res.timestamp || [];
      const closes = (res.indicators?.adjclose?.[0]?.adjclose) ||
                     (res.indicators?.quote?.[0]?.close) || [];
      const dates = ts.map(t=> new Date(t*1000).toISOString().slice(0,10));
      // éæ¿¾ null close
      const outDates=[], outCloses=[];
      for(let i=0;i<closes.length;i++){
        const c = closes[i];
        if(c!=null && isFinite(c)){
          outDates.push(dates[i]);
          outCloses.push(c);
        }
      }
      return { dates: outDates, closes: outCloses };
    }

    // ===== Live-ish update (poll quotes only) =====
    let livePollTimer=null;
    async function startLivePoll(){
      if(livePollTimer) clearInterval(livePollTimer);
      await refreshQuotes(); // å…ˆæ›´æ–°ä¸€æ¬¡
      livePollTimer = setInterval(refreshQuotes, QUOTE_POLL_MS);
    }

    // ===== UI helpers =====
    function setAPIBadge(ok, msg=''){
      const el = document.getElementById('apiHealth');
      el.textContent = ok ? 'API æ­£å¸¸' : 'API ç•°å¸¸';
      el.className = 'badge ' + (ok ? 'badge-ok' : 'badge-fail');
      if(msg) el.title = msg;
    }

    function updateQuoteUI(sym, price, prevClose, changePct){
      if(sym==='QQQ'){
        document.getElementById('qqqPrice').textContent = price? ('$'+price.toFixed(2)) : '--';
        const pct = changePct ?? (price && prevClose ? ((price-prevClose)/prevClose*100) : null);
        const t = document.getElementById('qqqChange');
        t.textContent = (pct!=null && isFinite(pct)) ? pct.toFixed(2)+'%' : '--%';
        t.className = 'metric-value ' + ((pct??0)>=0 ? 'positive' : 'negative');
      } else if(sym==='TQQQ'){
        document.getElementById('tqqqPrice').textContent = price? ('$'+price.toFixed(2)) : '--';
        const pct = changePct ?? (price && prevClose ? ((price-prevClose)/prevClose*100) : null);
        const t = document.getElementById('tqqqChange');
        t.textContent = (pct!=null && isFinite(pct)) ? pct.toFixed(2)+'%' : '--%';
        t.className = 'metric-value ' + ((pct??0)>=0 ? 'positive' : 'negative');
      } else if(sym==='^VIX'){
        if(price!=null) document.getElementById('vixLevel').textContent = price.toFixed(2);
        const risk = (price>30)?'é«˜':(price>20)?'ä¸­':'ä½';
        document.getElementById('drawdownRisk').textContent = isFinite(price)? risk : '--';
      }
    }

    // ===== Global state for chart/indicators =====
    let chartInstance=null;
    let latestQQQ = { price:null, sma200:null, isAbove:null, dist:null };

    async function refreshDaily(){
      try{
        document.getElementById('loadingIndicator').style.display='block';
        document.getElementById('dashboardContent').style.display='none';
        document.getElementById('chartSection').style.display='none';

        // æ‹¿æ—¥ç·šï¼ˆä¸€æ¬¡è«‹æ±‚ä¸€æª”ï¼›ä¸”å¿«å– 1 å¤©ï¼‰
        const [qqqD, tqqqD] = await Promise.all([
          getDailyCloses('QQQ','2y'),
          getDailyCloses('TQQQ','2y')
        ]);

        const qqqSMA200 = sma(qqqD.closes, 200);
        latestQQQ.sma200 = qqqSMA200;

        // è¿‘ 90 äº¤æ˜“æ—¥è³‡æ–™ + SMA200
        const hist = [];
        const n = Math.min(90, qqqD.dates.length);
        for(let i=qqqD.dates.length - n; i<qqqD.dates.length; i++){
          const slice = qqqD.closes.slice(0, i+1);
          const s200 = sma(slice, 200);
          hist.push({ date: qqqD.dates[i], price: qqqD.closes[i], sma200: s200 });
        }

        // TQQQ æŒ‡æ¨™ï¼ˆç”¨æ—¥ç·šï¼‰
        const tVol = vol(tqqqD.closes, 20);
        const tRSI = rsi(tqqqD.closes, 14);

        // ç•«åœ–
        const ctx = document.getElementById('priceChart').getContext('2d');
        const labels = hist.map(d=>d.date);
        const priceSeries = hist.map(d=>d.price);
        const smaSeries = hist.map(d=>d.sma200);
        if(chartInstance) chartInstance.destroy();
        chartInstance = new Chart(ctx, {
          type:'line',
          data:{labels, datasets:[
            {label:'QQQ', data:priceSeries, borderWidth:2, fill:false, tension:.2},
            {label:'SMA200', data:smaSeries, borderWidth:2, borderDash:[6,4], fill:false, tension:.2}
          ]},
          options:{responsive:true, plugins:{legend:{display:true}}}
        });

        // æ›´æ–°å³å´çµ±è¨ˆï¼ˆéƒ¨åˆ†éœ€è¦ quote æ‰èƒ½å®Œæˆ isAbove/è·é›¢ï¼‰
        document.getElementById('tqqqVolatility').textContent = tVol? tVol.toFixed(1)+'%':'--';
        document.getElementById('tqqqRsi').textContent = tRSI? tRSI.toFixed(0):'--';

        document.getElementById('loadingIndicator').style.display='none';
        document.getElementById('errorAlert').style.display='none';
        document.getElementById('dashboardContent').style.display='grid';
        document.getElementById('chartSection').style.display='block';

        // å–ä¸€æ¬¡ quoteï¼ˆèµ°å¿«å–ï¼‰ï¼Œè£œé½Šç¾åƒ¹ & è¨Šè™Ÿ
        await refreshQuotes(true);

      }catch(err){
        console.error(err);
        document.getElementById('loadingIndicator').style.display='none';
        document.getElementById('errorAlert').style.display='block';
        setAPIBadge(false, 'æ—¥ç·šè¼‰å…¥å¤±æ•—');
      }
    }

    async function refreshQuotes(useCache=true){
      try{
        const syms = ['QQQ','TQQQ','^VIX'];
        const map = await getQuotes(syms, useCache);
        const qqq = map['QQQ']||{}, tqqq = map['TQQQ']||{}, vix = map['^VIX']||{};
        // æ›´æ–° UI
        updateQuoteUI('QQQ', qqq.price, qqq.prevClose, qqq.changePct);
        updateQuoteUI('TQQQ', tqqq.price, tqqq.prevClose, tqqq.changePct);
        updateQuoteUI('^VIX', vix.price, vix.prevClose, vix.changePct);

        // è£œé½Šç­–ç•¥ & LRS ç‹€æ…‹ï¼ˆéœ€è¦æœ€æ–° QQQ + SMA200ï¼‰
        latestQQQ.price = qqq.price ?? null;
        if(latestQQQ.price!=null && latestQQQ.sma200!=null){
          latestQQQ.isAbove = latestQQQ.price > latestQQQ.sma200;
          latestQQQ.dist = ((latestQQQ.price - latestQQQ.sma200)/latestQQQ.sma200*100);
          applySignal(latestQQQ.isAbove, latestQQQ.dist);
        }

        document.getElementById('lastUpdate').textContent = new Date().toLocaleString('zh-TW');
        setAPIBadge(true,'');
      }catch(err){
        console.error('[refreshQuotes] error', err);
        setAPIBadge(false, 'Quote å¤±æ•—');
      }
    }

    function applySignal(isAbove, distance){
      const signalEl = document.getElementById('signalStatus');
      const descEl = document.getElementById('signalDescription');
      const actionEl = document.getElementById('actionRequired');

      signalEl.className = 'signal-status ' + (isAbove ? 'signal-tqqq' : 'signal-cash');
      signalEl.textContent = isAbove ? 'æŒæœ‰ TQQQ' : 'æŒæœ‰ ç¾é‡‘è…¿';
      descEl.textContent = isAbove
        ? 'QQQ æ”¶ç›¤ > SMA200ï¼Œå•Ÿç”¨æ§“æ¡¿è…¿'
        : 'QQQ æ”¶ç›¤ â‰¤ SMA200ï¼Œè½‰å…¥ç¾é‡‘è…¿';

      document.getElementById('qqqSma200').textContent = latestQQQ.sma200!=null ? ('$'+latestQQQ.sma200.toFixed(2)) : '--';
      document.getElementById('qqqDistance').textContent = (distance!=null && isFinite(distance)) ? distance.toFixed(2)+'%' : '--';
      document.getElementById('trendStrength').textContent = (distance!=null && Math.abs(distance)>5) ? 'å¼·':'å¼±';
      document.getElementById('signalStability').textContent = 'â€”'; // ç°¡åŒ–ï¼šå¯æ“´å……äº¤å‰æ¬¡æ•¸
      actionEl.style.display = 'none';
    }

    // å¥åº·æª¢æŸ¥ï¼šæ‰“ä¸€æ¬¡ quoteï¼ˆä¸èµ°å¿«å–ï¼‰
    async function runHealthCheck(){
      try{
        const map = await getQuotes(['QQQ','TQQQ','^VIX'], false); // no cache
        const ok = ['QQQ','TQQQ','^VIX'].every(s=> map[s]?.price!=null);
        setAPIBadge(ok, ok?'OK':'æœ‰ä»£ç¢¼ç„¡å›æ‡‰ï¼ˆçœ‹ Consoleï¼‰');
        console.log('[HealthCheck] quotes:', map);
      }catch(e){
        console.error('[HealthCheck] error', e);
        setAPIBadge(false, String(e));
      }
    }

    // ===== Init =====
    (async function(){
      await refreshDaily();     // å…ˆè¼‰å…¥æ—¥ç·šèˆ‡ä¸€æ¬¡ quoteï¼ˆèµ°å¿«å–ï¼‰
      startLivePoll();          // ä¹‹å¾Œæ¯ 3 åˆ†é˜æ›´æ–°ä¸€æ¬¡ quoteï¼ˆå–®ç­†è«‹æ±‚ï¼Œå« QQQ/TQQQ/^VIXï¼‰
      document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) refreshQuotes(false); });
    })();
  </script>
</body>
</html>
