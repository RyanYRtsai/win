<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>TQQQ LRS 策略儀表板（Finnhub）</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;color:#333}
    .container{max-width:1400px;margin:0 auto;padding:20px;position:relative}
    .header{text-align:center;margin-bottom:30px;color:white;position:relative}
    .header h1{font-size:2.2rem;margin-bottom:10px;text-shadow:2px 2px 4px rgba(0,0,0,.3)}
    .last-updated{background:rgba(255,255,255,.2);padding:8px 16px;border-radius:20px;display:inline-block;backdrop-filter:blur(10px)}
    .header-right{position:absolute;top:0;right:0;display:flex;gap:8px;align-items:center}
    .dashboard{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:20px;margin-bottom:30px}
    .card{background:rgba(255,255,255,.95);border-radius:16px;padding:24px;box-shadow:0 8px 32px rgba(0,0,0,.1);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.2);transition:transform .3s ease,box-shadow .3s ease}
    .card:hover{transform:translateY(-4px);box-shadow:0 12px 40px rgba(0,0,0,.15)}
    .card-title{font-size:1.15rem;font-weight:600;margin-bottom:16px;color:#2d3748;display:flex;align-items:center;gap:8px}
    .signal-card{text-align:center;position:relative;overflow:hidden}
    .signal-status{font-size:2.6rem;font-weight:bold;margin:20px 0;text-shadow:2px 2px 4px rgba(0,0,0,.1)}
    .signal-tqqq{color:#22c55e;animation:pulse 2s ease-in-out infinite}
    .signal-cash{color:#ef4444}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.7}}
    .signal-description{font-size:1.05rem;color:#64748b;margin-bottom:16px}
    .action-required{background:linear-gradient(135deg,#fbbf24,#f59e0b);color:#fff;padding:12px 24px;border-radius:8px;font-weight:600;font-size:1.05rem;animation:glow 2s ease-in-out infinite alternate}
    @keyframes glow{from{box-shadow:0 0 20px rgba(251,191,36,.4)}to{box-shadow:0 0 30px rgba(251,191,36,.8)}}
    .metric{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid #e2e8f0}
    .metric:last-child{border-bottom:none}
    .metric-label{color:#64748b;font-size:.9rem}
    .metric-value{font-weight:600;font-size:1.05rem}
    .positive{color:#22c55e}
    .negative{color:#ef4444}
    .chart-container{grid-column:1 / -1;height:400px}
    .loading{text-align:center;color:white;font-size:1.1rem;margin:40px 0}
    .loading::after{content:'...';animation:dots 1.5s steps(4,end) infinite}
    @keyframes dots{0%,20%{content:''}40%{content:'.'}60%{content:'..'}80%,100%{content:'...'}}
    .refresh-btn{background:rgba(255,255,255,.2);border:1px solid rgba(255,255,255,.3);color:white;padding:8px 12px;border-radius:8px;cursor:pointer;transition:all .3s ease;backdrop-filter:blur(10px)}
    .refresh-btn:hover{background:rgba(255,255,255,.3);transform:scale(1.05)}
    .alert{background:linear-gradient(135deg,#dc2626,#991b1b);color:#fff;padding:16px;border-radius:8px;margin-bottom:20px;text-align:center;font-weight:600}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:.78rem}
    .badge-ok{background:#16a34a;color:white}
    .badge-fail{background:#dc2626;color:white}
    .tooltip{background:rgba(255,255,255,.2);color:#fff;padding:6px 10px;border-radius:8px}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>📊 TQQQ LRS 策略儀表板（Finnhub）</h1>
      <div class="last-updated">
        <span id="lastUpdate">載入中...</span>
        <button class="refresh-btn" onclick="refreshData()">🔄 更新（日線）</button>
      </div>
      <div class="header-right">
        <button class="refresh-btn" onclick="runHealthCheck()">🩺 健康檢查</button>
        <span id="apiHealth" class="badge">API 檢測中</span>
        <span id="wsHealth" class="badge">WS 檢測中</span>
      </div>
    </div>

    <div id="loadingIndicator" class="loading"> 正在載入市場數據 </div>
    <div id="errorAlert" class="alert" style="display:none;">⚠️ 無法載入數據，請檢查金鑰或稍後重試</div>

    <div id="dashboardContent" class="dashboard" style="display:none;">
      <div class="card signal-card">
        <h2 class="card-title">🎯 當前策略信號</h2>
        <div id="signalStatus" class="signal-status">載入中...</div>
        <div id="signalDescription" class="signal-description">分析中...</div>
        <div id="actionRequired" class="action-required" style="display:none;">需要調整倉位！</div>
      </div>

      <div class="card">
        <h2 class="card-title">📈 QQQ 價格資訊</h2>
        <div class="metric"><span class="metric-label">當前價格</span><span id="qqqPrice" class="metric-value">$--</span></div>
        <div class="metric"><span class="metric-label">200日均線</span><span id="qqqSma200" class="metric-value">$--</span></div>
        <div class="metric"><span class="metric-label">距離均線</span><span id="qqqDistance" class="metric-value">--%</span></div>
        <div class="metric"><span class="metric-label">日變化</span><span id="qqqChange" class="metric-value">--%</span></div>
      </div>

      <div class="card">
        <h2 class="card-title">🚀 TQQQ 價格資訊</h2>
        <div class="metric"><span class="metric-label">當前價格</span><span id="tqqqPrice" class="metric-value">$--</span></div>
        <div class="metric"><span class="metric-label">日變化</span><span id="tqqqChange" class="metric-value">--%</span></div>
        <div class="metric"><span class="metric-label">波動率 (20日)</span><span id="tqqqVolatility" class="metric-value">--%</span></div>
        <div class="metric"><span class="metric-label">RSI (14日)</span><span id="tqqqRsi" class="metric-value">--</span></div>
      </div>

      <div class="card">
        <h2 class="card-title">📊 策略統計</h2>
        <div class="metric"><span class="metric-label">本月信號變化</span><span id="monthlySignals" class="metric-value">-- 次</span></div>
        <div class="metric"><span class="metric-label">目前週期天數</span><span id="currentCycleDays" class="metric-value">-- 天</span></div>
        <div class="metric"><span class="metric-label">TQQQ 持有比例 (YTD)</span><span id="tqqqHoldingRatio" class="metric-value">--%</span></div>
        <div class="metric"><span class="metric-label">策略勝率 (近30天)</span><span id="winRate" class="metric-value">--%</span></div>
      </div>

      <div class="card">
        <h2 class="card-title">⚠️ 風險指標</h2>
        <div class="metric"><span class="metric-label">VIX 指數</span><span id="vixLevel" class="metric-value">--</span></div>
        <div class="metric"><span class="metric-label">市場趨勢強度</span><span id="trendStrength" class="metric-value">--</span></div>
        <div class="metric"><span class="metric-label">回撤風險</span><span id="drawdownRisk" class="metric-value">--</span></div>
        <div class="metric"><span class="metric-label">信號穩定性</span><span id="signalStability" class="metric-value">--</span></div>
      </div>

      <div class="card">
        <h2 class="card-title">💡 建議行動</h2>
        <div id="recommendations" style="line-height:1.6;">
          <div class="loading">分析中...</div>
        </div>
      </div>
    </div>

    <div id="chartSection" style="display:none;">
      <div class="card chart-container">
        <h2 class="card-title">📈 QQQ 價格 vs 200日均線 (近90天)</h2>
        <canvas id="priceChart"></canvas>
      </div>
    </div>
  </div>

  <script>
    // ====== Finnhub 設定 ======
    const FINNHUB_KEY = 'd2ev6o9r01qmrq4p164gd2ev6o9r01qmrq4p1650';
    const FH_BASE = 'https://finnhub.io/api/v1';
    const WS_URL = `wss://ws.finnhub.io?token=${encodeURIComponent(FINNHUB_KEY)}`;

    // ====== 額度友善策略（可調） ======
    const QUOTE_CACHE_MS = 10 * 60 * 1000;   // /quote 快取 10 分鐘
    const CANDLE_CACHE_MS = 24 * 60 * 60 * 1000; // 日線快取 1 天
    const WS_POLL_FALLBACK_MS = 60 * 1000;   // WS 失敗時，QQQ/TQQQ 每 1 分鐘輪詢
    const VIX_REST_FALLBACK_MS = 10 * 60 * 1000; // VIX 串流失敗時，每 10 分鐘抓一次
    const VIX_WS_WAIT_MS = 20 * 1000;        // 嘗試 VIX 串流等待 20 秒

    // ====== localStorage 快取 ======
    const LS_PREFIX = 'tqqq_fh_';
    function cacheGet(k){try{const r=localStorage.getItem(LS_PREFIX+k);if(!r)return null;const o=JSON.parse(r);if(o.exp && Date.now()>o.exp){localStorage.removeItem(LS_PREFIX+k);return null}return o.val}catch{return null}}
    function cacheSet(k,v,ttl){localStorage.setItem(LS_PREFIX+k,JSON.stringify({val:v,exp:ttl?Date.now()+ttl:0}))}

    async function fetchJSON(url, cacheKey=null, ttlMs=0){
      if(cacheKey){const c=cacheGet(cacheKey); if(c) return c;}
      const res = await fetch(url);
      if(!res.ok) throw new Error('HTTP '+res.status);
      const j = await res.json();
      if(cacheKey && ttlMs) cacheSet(cacheKey,j,ttlMs);
      return j;
    }

    // ====== 指標 ======
    function computeSMA(arr, win){ if(arr.length<win) return null; const s=arr.slice(-win).reduce((a,b)=>a+b,0); return s/win }
    function computeRSI(arr, p=14){
      if(arr.length<=p) return null;
      let g=0,l=0;
      for(let i=arr.length-p;i<arr.length;i++){
        const d = arr[i]-arr[i-1];
        if(d>=0) g+=d; else l-=d;
      }
      const rs = l===0 ? 100 : g/l;
      return 100 - (100/(1+rs));
    }
    function computeVol(arr, look=20){
      if(arr.length<look+1) return null;
      const seg = arr.slice(-look-1);
      const rets = [];
      for(let i=1;i<seg.length;i++) rets.push((seg[i]-seg[i-1])/seg[i-1]);
      const m = rets.reduce((a,b)=>a+b,0)/rets.length;
      const v = rets.reduce((a,b)=>a+Math.pow(b-m,2),0)/(rets.length-1);
      return Math.sqrt(v)*Math.sqrt(252)*100;
    }

    // ====== REST 端點 ======
    async function getDailyCandles(symbol, days=500){
      const to = Math.floor(Date.now()/1000);
      const from = to - Math.floor(days*24*60*60*1.2);
      const url = `${FH_BASE}/stock/candle?symbol=${encodeURIComponent(symbol)}&resolution=D&from=${from}&to=${to}&token=${encodeURIComponent(FINNHUB_KEY)}`;
      const j = await fetchJSON(url, `candle_${symbol}`, CANDLE_CACHE_MS);
      if(j.s!=='ok') throw new Error('No candle data: '+symbol);
      const dates = j.t.map(ts => new Date(ts*1000).toISOString().slice(0,10));
      const closes = j.c;
      return {dates, closes};
    }

    async function getQuote(symbol){
      const url = `${FH_BASE}/quote?symbol=${encodeURIComponent(symbol)}&token=${encodeURIComponent(FINNHUB_KEY)}`;
      const j = await fetchJSON(url, `quote_${symbol}`, QUOTE_CACHE_MS);
      return { price:j.c||0, changePct:j.dp||0, prevClose:j.pc||0, ts:j.t? new Date(j.t*1000): new Date() };
    }

    // ====== WebSocket（即時） ======
    let ws=null, wsTimer=null, wsBackoff=2000, wsHealthy=false;
    const subs = new Set(['QQQ','TQQQ']); // 先訂 QQQ/TQQQ
    const lastPrice = { QQQ: null, TQQQ: null, VIX: null };
    const prevClose = { QQQ: null, TQQQ: null, VIX: null };

    const VIX_SYMBOL_CANDIDATES = ['^VIX','VIX','CBOE:VIX','INDEX:VIX','TVC:VIX'];
    let vixStreamingOK = false;
    let vixRestTimer = null;

    function setWSBadge(ok){
      wsHealthy = ok;
      const el = document.getElementById('wsHealth');
      el.textContent = ok ? 'WS 連線正常' : 'WS 未連線';
      el.className = 'badge ' + (ok ? 'badge-ok' : 'badge-fail');
    }
    function setAPIBadge(ok, msg=''){
      const el = document.getElementById('apiHealth');
      el.textContent = ok ? 'API 正常' : 'API 異常';
      el.className = 'badge ' + (ok ? 'badge-ok' : 'badge-fail');
      if(msg) el.title = msg;
    }

    function openWS(){
      try{ ws = new WebSocket(WS_URL); }catch(e){ setWSBadge(false); scheduleReconnect(); return; }
      ws.onopen = ()=>{
        setWSBadge(true);
        wsBackoff = 2000;
        // 訂閱股票
        subs.forEach(s => ws.send(JSON.stringify({type:'subscribe', symbol:s})));
        // 嘗試訂閱 VIX 指數（若供應商支援）
        VIX_SYMBOL_CANDIDATES.forEach(sym => ws.send(JSON.stringify({type:'subscribe', symbol:sym})));
        // 若 20 秒沒收到任何 VIX 相關訊息，啟用 REST 後備
        setTimeout(()=>{ if(!vixStreamingOK) startVixRestFallback(); }, VIX_WS_WAIT_MS);
      };
      ws.onmessage = (ev)=>{
        const msg = JSON.parse(ev.data);
        if(msg.type==='trade' && Array.isArray(msg.data)){
          msg.data.forEach(t=>{
            const s = t.s, p = t.p;
            // 偵測 VIX 指數串
