<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TQQQ LRS ç­–ç•¥å„€è¡¨æ¿</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: #333; }
    .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
    .header { text-align: center; margin-bottom: 30px; color: white; }
    .header h1 { font-size: 2.5rem; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
    .last-updated { background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 20px; display: inline-block; backdrop-filter: blur(10px); }
    .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .card { background: rgba(255, 255, 255, 0.95); border-radius: 16px; padding: 24px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); transition: transform 0.3s ease, box-shadow 0.3s ease; }
    .card:hover { transform: translateY(-4px); box-shadow: 0 12px 40px rgba(0,0,0,0.15); }
    .card-title { font-size: 1.2rem; font-weight: 600; margin-bottom: 16px; color: #2d3748; display: flex; align-items: center; gap: 8px; }
    .signal-card { text-align: center; position: relative; overflow: hidden; }
    .signal-status { font-size: 3rem; font-weight: bold; margin: 20px 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.1); }
    .signal-tqqq { color: #22c55e; animation: pulse 2s ease-in-out infinite; }
    .signal-cash { color: #ef4444; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    .signal-description { font-size: 1.1rem; color: #64748b; margin-bottom: 16px; }
    .action-required { background: linear-gradient(135deg, #fbbf24, #f59e0b); color: white; padding: 12px 24px; border-radius: 8px; font-weight: 600; font-size: 1.1rem; animation: glow 2s ease-in-out infinite alternate; }
    @keyframes glow { from { box-shadow: 0 0 20px rgba(251, 191, 36, 0.4); } to { box-shadow: 0 0 30px rgba(251, 191, 36, 0.8); } }
    .metric { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #e2e8f0; }
    .metric:last-child { border-bottom: none; }
    .metric-label { color: #64748b; font-size: 0.9rem; }
    .metric-value { font-weight: 600; font-size: 1.1rem; }
    .positive { color: #22c55e; }
    .negative { color: #ef4444; }
    .chart-container { grid-column: 1 / -1; height: 400px; }
    .status-indicator { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 8px; }
    .status-buy { background: #22c55e; }
    .status-sell { background: #ef4444; }
    .loading { text-align: center; color: white; font-size: 1.2rem; margin: 40px 0; }
    .loading::after { content: '...'; animation: dots 1.5s steps(4, end) infinite; }
    @keyframes dots { 0%, 20% { content: ''; } 40% { content: '.'; } 60% { content: '..'; } 80%, 100% { content: '...'; } }
    .refresh-btn { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 8px 16px; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; backdrop-filter: blur(10px); }
    .refresh-btn:hover { background: rgba(255,255,255,0.3); transform: scale(1.05); }
    .alert { background: linear-gradient(135deg, #dc2626, #991b1b); color: white; padding: 16px; border-radius: 8px; margin-bottom: 20px; text-align: center; font-weight: 600; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“Š TQQQ LRS ç­–ç•¥å„€è¡¨æ¿</h1>
      <div class="last-updated">
        <span id="lastUpdate">è¼‰å…¥ä¸­...</span>
        <button class="refresh-btn" onclick="refreshData()">ğŸ”„ æ›´æ–°</button>
      </div>
    </div>

    <div id="loadingIndicator" class="loading"> æ­£åœ¨è¼‰å…¥å¸‚å ´æ•¸æ“š </div>
    <div id="errorAlert" class="alert" style="display: none;"> âš ï¸ ç„¡æ³•è¼‰å…¥æ•¸æ“šï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œé‡è©¦ </div>

    <div id="dashboardContent" class="dashboard" style="display: none;">
      <!-- ä¸»è¦ä¿¡è™Ÿå¡ -->
      <div class="card signal-card">
        <h2 class="card-title">ğŸ¯ ç•¶å‰ç­–ç•¥ä¿¡è™Ÿ</h2>
        <div id="signalStatus" class="signal-status">è¼‰å…¥ä¸­...</div>
        <div id="signalDescription" class="signal-description">åˆ†æä¸­...</div>
        <div id="actionRequired" class="action-required" style="display: none;"> éœ€è¦èª¿æ•´å€‰ä½ï¼ </div>
      </div>

      <!-- QQQ åƒ¹æ ¼è³‡è¨Š -->
      <div class="card">
        <h2 class="card-title">ğŸ“ˆ QQQ åƒ¹æ ¼è³‡è¨Š</h2>
        <div class="metric"><span class="metric-label">ç•¶å‰åƒ¹æ ¼</span><span id="qqqPrice" class="metric-value">$--</span></div>
        <div class="metric"><span class="metric-label">200æ—¥å‡ç·š</span><span id="qqqSma200" class="metric-value">$--</span></div>
        <div class="metric"><span class="metric-label">è·é›¢å‡ç·š</span><span id="qqqDistance" class="metric-value">--%</span></div>
        <div class="metric"><span class="metric-label">æ—¥è®ŠåŒ–</span><span id="qqqChange" class="metric-value">--%</span></div>
      </div>

      <!-- TQQQ åƒ¹æ ¼è³‡è¨Š -->
      <div class="card">
        <h2 class="card-title">ğŸš€ TQQQ åƒ¹æ ¼è³‡è¨Š</h2>
        <div class="metric"><span class="metric-label">ç•¶å‰åƒ¹æ ¼</span><span id="tqqqPrice" class="metric-value">$--</span></div>
        <div class="metric"><span class="metric-label">æ—¥è®ŠåŒ–</span><span id="tqqqChange" class="metric-value">--%</span></div>
        <div class="metric"><span class="metric-label">æ³¢å‹•ç‡ (20æ—¥)</span><span id="tqqqVolatility" class="metric-value">--%</span></div>
        <div class="metric"><span class="metric-label">RSI (14æ—¥)</span><span id="tqqqRsi" class="metric-value">--</span></div>
      </div>

      <!-- ç­–ç•¥çµ±è¨ˆ -->
      <div class="card">
        <h2 class="card-title">ğŸ“Š ç­–ç•¥çµ±è¨ˆ</h2>
        <div class="metric"><span class="metric-label">æœ¬æœˆä¿¡è™Ÿè®ŠåŒ–</span><span id="monthlySignals" class="metric-value">-- æ¬¡</span></div>
        <div class="metric"><span class="metric-label">ç›®å‰é€±æœŸå¤©æ•¸</span><span id="currentCycleDays" class="metric-value">-- å¤©</span></div>
        <div class="metric"><span class="metric-label">TQQQ æŒæœ‰æ¯”ä¾‹ (YTD)</span><span id="tqqqHoldingRatio" class="metric-value">--%</span></div>
        <div class="metric"><span class="metric-label">ç­–ç•¥å‹ç‡ (è¿‘30å¤©)</span><span id="winRate" class="metric-value">--%</span></div>
      </div>

      <!-- é¢¨éšªæŒ‡æ¨™ -->
      <div class="card">
        <h2 class="card-title">âš ï¸ é¢¨éšªæŒ‡æ¨™</h2>
        <div class="metric"><span class="metric-label">VIX ææ…ŒæŒ‡æ•¸</span><span id="vixLevel" class="metric-value">--</span></div>
        <div class="metric"><span class="metric-label">å¸‚å ´è¶¨å‹¢å¼·åº¦</span><span id="trendStrength" class="metric-value">--</span></div>
        <div class="metric"><span class="metric-label">å›æ’¤é¢¨éšª</span><span id="drawdownRisk" class="metric-value">--</span></div>
        <div class="metric"><span class="metric-label">ä¿¡è™Ÿç©©å®šæ€§</span><span id="signalStability" class="metric-value">--</span></div>
      </div>

      <!-- å»ºè­°è¡Œå‹• -->
      <div class="card">
        <h2 class="card-title">ğŸ’¡ å»ºè­°è¡Œå‹•</h2>
        <div id="recommendations" style="line-height: 1.6;">
          <div class="loading">åˆ†æä¸­...</div>
        </div>
      </div>
    </div>

    <!-- åƒ¹æ ¼åœ–è¡¨ -->
    <div id="chartSection" style="display: none;">
      <div class="card chart-container">
        <h2 class="card-title">ğŸ“ˆ QQQ åƒ¹æ ¼ vs 200æ—¥å‡ç·š (è¿‘90å¤©)</h2>
        <canvas id="priceChart"></canvas>
      </div>
    </div>
  </div>

  <script>
    // ===== Alpha Vantage é€£ç·šè¨­å®š =====
    const API_KEY = '4YZG2Z3MMYRBPIKI';
    const BASE_URL = 'https://www.alphavantage.co/query';

    // å…è²»å±¤é…é¡å¾ˆä½ï¼šé è¨­ä¿å®ˆåˆ·æ–°ï¼›å‡ç´šå¾Œå¯æ”¹ç‚º 'premium'
    const PLAN = 'free'; // 'free' | 'premium'
    const CALL_LIMIT_DAILY = PLAN === 'premium' ? 3000 : 25;

    // ä¾æ–¹æ¡ˆèª¿æ•´åˆ·æ–°é »ç‡
    const QUOTE_REFRESH_MS = PLAN === 'premium' ? 60 * 1000 : 2 * 60 * 60 * 1000; // å ±åƒ¹å¿«ç…§
    const DAILY_REFRESH_MS = 24 * 60 * 60 * 1000; // æ—¥ç·šï¼ˆç®— SMA/RSI/Volï¼‰

    // ===== å¿«å– / é…é¡å®ˆé–€å“¡ =====
    const LS_PREFIX = 'tqqq_lrs_';
    const todayKey = () => new Date().toISOString().slice(0,10);

    function cacheGet(key) {
      try {
        const raw = localStorage.getItem(LS_PREFIX + key);
        if (!raw) return null;
        const obj = JSON.parse(raw);
        if (obj.exp && Date.now() > obj.exp) { localStorage.removeItem(LS_PREFIX + key); return null; }
        return obj.val;
      } catch { return null; }
    }
    function cacheSet(key, val, ttlMs) {
      localStorage.setItem(LS_PREFIX + key, JSON.stringify({ val, exp: ttlMs ? Date.now() + ttlMs : 0 }));
    }
    function getCallCounter() {
      const raw = localStorage.getItem(LS_PREFIX + 'calls');
      const t = todayKey();
      if (!raw) return { d: t, n: 0 };
      try {
        const obj = JSON.parse(raw);
        return obj.d === t ? obj : { d: t, n: 0 };
      } catch { return { d: t, n: 0 }; }
    }
    function canCallAPI(need = 1) {
      const c = getCallCounter();
      return (c.n + need) <= CALL_LIMIT_DAILY;
    }
    function countCallAPI(used = 1) {
      const c = getCallCounter();
      const obj = { d: todayKey(), n: c.d === todayKey() ? c.n + used : used };
      localStorage.setItem(LS_PREFIX + 'calls', JSON.stringify(obj));
    }

    // ===== åŸºæœ¬ fetch åŒ…è£ï¼ˆå«å®ˆé–€å“¡ï¼‹éŒ¯èª¤è™•ç†ï¼‰ =====
    async function avFetch(params, cacheKey, ttlMs) {
      const cached = cacheGet(cacheKey);
      if (cached) return cached;

      if (!canCallAPI(1)) throw new Error('Daily API call limit reached');
      const url = BASE_URL + '?' + new URLSearchParams({ apikey: API_KEY, ...params }).toString();
      const res = await fetch(url);
      if (!res.ok) throw new Error('API request failed');
      const json = await res.json();

      if (json.Note || json.Information || json['Error Message']) {
        throw new Error(json.Note || json.Information || json['Error Message']);
      }

      countCallAPI(1);
      cacheSet(cacheKey, json, ttlMs);
      return json;
    }

    // ===== æŠ€è¡“æŒ‡æ¨™ï¼ˆå‰ç«¯è¨ˆç®—ï¼‰ =====
    function computeSMA(values, window) {
      if (values.length < window) return null;
      const slice = values.slice(-window);
      return slice.reduce((a,b)=>a+b,0) / window;
    }
    function computeRSI(values, period = 14) {
      if (values.length <= period) return null;
      let gains = 0, losses = 0;
      for (let i = values.length - period; i < values.length; i++) {
        const diff = values[i] - values[i-1];
        if (diff >= 0) gains += diff; else losses -= diff;
      }
      const rs = losses === 0 ? 100 : gains / losses;
      return 100 - (100 / (1 + rs));
    }
    function computeVol(values, lookback = 20) {
      if (values.length < (lookback + 1)) return null;
      const last = values.slice(- (lookback + 1));
      const rets = [];
      for (let i=1;i<last.length;i++) rets.push((last[i]-last[i-1]) / last[i-1]);
      const mean = rets.reduce((a,b)=>a+b,0) / rets.length;
      const variance = rets.reduce((a,b)=>a + Math.pow(b-mean,2),0) / (rets.length - 1);
      return Math.sqrt(variance) * Math.sqrt(252) * 100; // å¹´åŒ– %
    }

    // ===== å–æ•¸å°è£ =====
    async function getDailySeries(symbol) {
      // ç”¨ outputsize=full æ‰å¤  200D SMAï¼›æ¯å¤©å¿«å–ä¸€æ¬¡
      const key = `daily_${symbol}`;
      const json = await avFetch({ function:'TIME_SERIES_DAILY', symbol, outputsize:'full' }, key, DAILY_REFRESH_MS);
      const ts = json['Time Series (Daily)'] || {};
      const dates = Object.keys(ts).sort((a,b)=> new Date(a) - new Date(b));
      const closes = dates.map(d => parseFloat(ts[d]['4. close']));
      return { dates, closes };
    }
    async function getQuote(symbol) {
      const key = `quote_${symbol}`;
      const json = await avFetch({ function:'GLOBAL_QUOTE', symbol }, key, QUOTE_REFRESH_MS);
      const g = json['Global Quote'] || {};
      return {
        price: parseFloat(g['05. price'] || '0'),
        changePct: parseFloat((g['10. change percent'] || '0').replace('%',''))
      };
    }
    async function getVIX() {
      try { return await getQuote('^VIX'); }
      catch { try { return await getQuote('VIX'); }
      catch { return await getQuote('VIXY'); } }
    }

    // ===== ä¸»æµç¨‹ï¼šæŠ“è³‡æ–™ï¼‹ç®—ç­–ç•¥ =====
    let chartInstance = null;

    async function fetchMarketData() {
      const [qqqDaily, tqqqDaily] = await Promise.all([
        getDailySeries('QQQ'), getDailySeries('TQQQ')
      ]);
      const [qqqQ, tqqqQ] = await Promise.all([
        getQuote('QQQ'), getQuote('TQQQ')
      ]);
      let vixQ = { price: NaN, changePct: NaN };
      try { vixQ = await getVIX(); } catch {}

      // QQQ æŒ‡æ¨™
      const qqqSMA200 = computeSMA(qqqDaily.closes, 200);
      const qqqPrice = qqqQ.price;
      const isAbove = qqqSMA200 ? qqqPrice > qqqSMA200 : null;
      const distance = qqqSMA200 ? ((qqqPrice - qqqSMA200) / qqqSMA200) * 100 : null;

      // TQQQ æŒ‡æ¨™
      const tVol = computeVol(tqqqDaily.closes, 20);
      const tRSI = computeRSI(tqqqDaily.closes, 14);

      // è¿‘ 90 å¤©åœ–è¡¨è³‡æ–™ï¼ˆå« SMA200ï¼‰
      const hist = [];
      const n = Math.min(90, qqqDaily.dates.length);
      for (let i = qqqDaily.dates.length - n; i < qqqDaily.dates.length; i++) {
        const slice = qqqDaily.closes.slice(0, i+1);
        const sma = computeSMA(slice, 200);
        hist.push({ date: qqqDaily.dates[i], price: qqqDaily.closes[i], sma200: sma });
      }

      // ç­–ç•¥çµ±è¨ˆ
      let monthlySignals = 0, holdingCount = 0;
      for (let i=1;i<hist.length;i++) {
        const a = hist[i-1], b = hist[i];
        if (a.sma200 && b.sma200) {
          const prevAbove = a.price > a.sma200;
          const nowAbove = b.price > b.sma200;
          if (prevAbove !== nowAbove) monthlySignals++;
          if (nowAbove) holdingCount++;
        }
      }
      let streak = 1;
      for (let i=hist.length-2;i>=0;i--) {
        const a = hist[i], b = hist[i+1];
        if (a.sma200 && b.sma200 && (a.price > a.sma200) === (b.price > b.sma200)) streak++;
        else break;
      }

      return {
        lastUpdate: new Date().toLocaleString('zh-TW'),
        qqq: {
          price: qqqPrice.toFixed(2),
          change: (qqqQ.changePct || 0).toFixed(2),
          sma200: qqqSMA200 ? qqqSMA200.toFixed(2) : '--',
          distance: qqqSMA200 ? distance.toFixed(2) : '--',
          isAboveSma: !!isAbove
        },
        tqqq: {
          price: tqqqQ.price.toFixed(2),
          change: (tqqqQ.changePct || 0).toFixed(2),
          volatility: tVol ? tVol.toFixed(1) : '--',
          rsi: tRSI ? tRSI.toFixed(0) : '--'
        },
        risk: {
          vix: Number.isFinite(vixQ.price) ? vixQ.price.toFixed(1) : '--',
          trendStrength: (qqqSMA200 && Math.abs(distance) > 5) ? 'å¼·' : 'å¼±',
          drawdownRisk: Number.isFinite(vixQ.price) ? (vixQ.price > 25 ? 'é«˜' : vixQ.price > 15 ? 'ä¸­' : 'ä½') : '--',
          signalStability: monthlySignals < 2 ? 'ç©©å®š' : 'ä¸ç©©å®š'
        },
        strategy: {
          signal: isAbove ? 'TQQQ' : 'CASH',
          monthlySignals,
          currentCycleDays: streak,
          holdingRatio: hist.length ? ((holdingCount / hist.length) * 100).toFixed(0) : '--',
          winRate: '--'
        },
        historicalData: hist
      };
    }

    function updateDashboard(data) {
      // Header
      document.getElementById('lastUpdate').textContent = data.lastUpdate;

      // Signal
      const signalEl = document.getElementById('signalStatus');
      const descEl = document.getElementById('signalDescription');
      const actionEl = document.getElementById('actionRequired');
      const isTQQQ = data.strategy.signal === 'TQQQ';
      signalEl.className = 'signal-status ' + (isTQQQ ? 'signal-tqqq' : 'signal-cash');
      signalEl.textContent = isTQQQ ? 'æŒæœ‰ TQQQ' : 'æŒæœ‰ ç¾é‡‘è…¿';
      descEl.textContent = isTQQQ ? 'QQQ æ”¶ç›¤ > SMA200ï¼Œå•Ÿç”¨æ§“æ¡¿è…¿' : 'QQQ æ”¶ç›¤ â‰¤ SMA200ï¼Œè½‰å…¥ç¾é‡‘è…¿';
      actionEl.style.display = 'none';

      // QQQ
      document.getElementById('qqqPrice').textContent = '$' + data.qqq.price;
      document.getElementById('qqqSma200').textContent = data.qqq.sma200 === '--' ? '--' : '$' + data.qqq.sma200;
      document.getElementById('qqqDistance').textContent = data.qqq.distance === '--' ? '--' : data.qqq.distance + '%';
      document.getElementById('qqqChange').textContent = (data.qqq.change || '0') + '%';
      document.getElementById('qqqChange').className = 'metric-value ' + ((parseFloat(data.qqq.change)||0) >= 0 ? 'positive' : 'negative');

      // TQQQ
      document.getElementById('tqqqPrice').textContent = '$' + data.tqqq.price;
      document.getElementById('tqqqChange').textContent = (data.tqqq.change || '0') + '%';
      document.getElementById('tqqqChange').className = 'metric-value ' + ((parseFloat(data.tqqq.change)||0) >= 0 ? 'positive' : 'negative');
      document.getElementById('tqqqVolatility').textContent = data.tqqq.volatility === '--' ? '--' : data.tqqq.volatility + '%';
      document.getElementById('tqqqRsi').textContent = data.tqqq.rsi;

      // Risk
      document.getElementById('vixLevel').textContent = data.risk.vix;
      document.getElementById('trendStrength').textContent = data.risk.trendStrength;
      document.getElementById('drawdownRisk').textContent = data.risk.drawdownRisk;
      document.getElementById('signalStability').textContent = data.risk.signalStability;

      // Strategy stats
      document.getElementById('monthlySignals').textContent = data.strategy.monthlySignals + ' æ¬¡';
      document.getElementById('currentCycleDays').textContent = data.strategy.currentCycleDays + ' å¤©';
      document.getElementById('tqqqHoldingRatio').textContent = data.strategy.holdingRatio + '%';
      document.getElementById('winRate').textContent = data.strategy.winRate;

      // Chart
      const ctx = document.getElementById('priceChart').getContext('2d');
      const labels = data.historicalData.map(d => d.date);
      const priceSeries = data.historicalData.map(d => d.price);
      const smaSeries = data.historicalData.map(d => d.sma200);

      if (window._priceChart) window._priceChart.destroy();
      window._priceChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            { label: 'QQQ', data: priceSeries, borderWidth: 2, fill: false, tension: 0.2 },
            { label: 'SMA200', data: smaSeries, borderWidth: 2, borderDash: [6,4], fill: false, tension: 0.2 }
          ]
        },
        options: { responsive: true, plugins: { legend: { display: true } } }
      });

      // é¡¯ç¤º
      document.getElementById('loadingIndicator').style.display = 'none';
      document.getElementById('errorAlert').style.display = 'none';
      document.getElementById('dashboardContent').style.display = 'grid';
      document.getElementById('chartSection').style.display = 'block';
    }

    async function refreshData() {
      document.getElementById('loadingIndicator').style.display = 'block';
      document.getElementById('dashboardContent').style.display = 'none';
      document.getElementById('chartSection').style.display = 'none';
      try {
        const data = await fetchMarketData();
        updateDashboard(data);
      } catch (err) {
        console.error(err);
        document.getElementById('loadingIndicator').style.display = 'none';
        document.getElementById('errorAlert').style.display = 'block';
      }
    }

    // é¦–æ¬¡è¼‰å…¥ + é€±æœŸåˆ·æ–°
    refreshData();
    setInterval(refreshData, QUOTE_REFRESH_MS);
    document.addEventListener('visibilitychange', () => { if (!document.hidden) refreshData(); });
  </script>
</body>
</html>
