<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TQQQ LRS 策略儀表板</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: #333; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; margin-bottom: 30px; color: white; }
        .header h1 { font-size: 2.5rem; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .last-updated { background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 20px; display: inline-block; backdrop-filter: blur(10px); }
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: rgba(255, 255, 255, 0.95); border-radius: 16px; padding: 24px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .card:hover { transform: translateY(-4px); box-shadow: 0 12px 40px rgba(0,0,0,0.15); }
        .card-title { font-size: 1.2rem; font-weight: 600; margin-bottom: 16px; color: #2d3748; display: flex; align-items: center; gap: 8px; }
        .signal-card { text-align: center; position: relative; overflow: hidden; }
        .signal-status { font-size: 3rem; font-weight: bold; margin: 20px 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.1); }
        .signal-tqqq { color: #22c55e; animation: pulse 2s ease-in-out infinite; }
        .signal-cash { color: #ef4444; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .signal-description { font-size: 1.1rem; color: #64748b; margin-bottom: 16px; }
        .action-required { background: linear-gradient(135deg, #fbbf24, #f59e0b); color: white; padding: 12px 24px; border-radius: 8px; font-weight: 600; font-size: 1.1rem; animation: glow 2s ease-in-out infinite alternate; }
        @keyframes glow { from { box-shadow: 0 0 20px rgba(251, 191, 36, 0.4); } to { box-shadow: 0 0 30px rgba(251, 191, 36, 0.8); } }
        .metric { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #e2e8f0; }
        .metric:last-child { border-bottom: none; }
        .metric-label { color: #64748b; font-size: 0.9rem; }
        .metric-value { font-weight: 600; font-size: 1.1rem; }
        .positive { color: #22c55e; }
        .negative { color: #ef4444; }
        .chart-container { grid-column: 1 / -1; height: 400px; }
        .status-indicator { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .status-buy { background: #22c55e; }
        .status-sell { background: #ef4444; }
        .loading { text-align: center; color: white; font-size: 1.2rem; margin: 40px 0; }
        .loading::after { content: '...'; animation: dots 1.5s steps(4, end) infinite; }
        @keyframes dots { 0%, 20% { content: ''; } 40% { content: '.'; } 60% { content: '..'; } 80%, 100% { content: '...'; } }
        .refresh-btn { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 8px 16px; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; backdrop-filter: blur(10px); }
        .refresh-btn:hover { background: rgba(255,255,255,0.3); transform: scale(1.05); }
        .alert { background: linear-gradient(135deg, #dc2626, #991b1b); color: white; padding: 16px; border-radius: 8px; margin-bottom: 20px; text-align: center; font-weight: 600; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📊 TQQQ LRS 策略儀表板</h1>
            <div class="last-updated">
                <span id="lastUpdate">載入中...</span>
                <button class="refresh-btn" onclick="refreshData()">🔄 更新</button>
            </div>
        </div>
        <div id="loadingIndicator" class="loading"> 正在載入市場數據 </div>
        <div id="errorAlert" class="alert" style="display: none;"> ⚠️ 無法載入數據，請檢查網路連線或稍後重試 </div>
        <div id="dashboardContent" class="dashboard" style="display: none;">
            <!-- 主要信號卡 -->
            <div class="card signal-card">
                <h2 class="card-title">🎯 當前策略信號</h2>
                <div id="signalStatus" class="signal-status">載入中...</div>
                <div id="signalDescription" class="signal-description">分析中...</div>
                <div id="actionRequired" class="action-required" style="display: none;"> 需要調整倉位！ </div>
            </div>
            <!-- QQQ 價格資訊 -->
            <div class="card">
                <h2 class="card-title">📈 QQQ 價格資訊</h2>
                <div class="metric">
                    <span class="metric-label">當前價格</span>
                    <span id="qqqPrice" class="metric-value">$--</span>
                </div>
                <div class="metric">
                    <span class="metric-label">200日均線</span>
                    <span id="qqqSma200" class="metric-value">$--</span>
                </div>
                <div class="metric">
                    <span class="metric-label">距離均線</span>
                    <span id="qqqDistance" class="metric-value">--%</span>
                </div>
                <div class="metric">
                    <span class="metric-label">日變化</span>
                    <span id="qqqChange" class="metric-value">--%</span>
                </div>
            </div>
            <!-- TQQQ 價格資訊 -->
            <div class="card">
                <h2 class="card-title">🚀 TQQQ 價格資訊</h2>
                <div class="metric">
                    <span class="metric-label">當前價格</span>
                    <span id="tqqqPrice" class="metric-value">$--</span>
                </div>
                <div class="metric">
                    <span class="metric-label">日變化</span>
                    <span id="tqqqChange" class="metric-value">--%</span>
                </div>
                <div class="metric">
                    <span class="metric-label">波動率 (20日)</span>
                    <span id="tqqqVolatility" class="metric-value">--%</span>
                </div>
                <div class="metric">
                    <span class="metric-label">RSI (14日)</span>
                    <span id="tqqqRsi" class="metric-value">--</span>
                </div>
            </div>
            <!-- 策略統計 -->
            <div class="card">
                <h2 class="card-title">📊 策略統計</h2>
                <div class="metric">
                    <span class="metric-label">本月信號變化</span>
                    <span id="monthlySignals" class="metric-value">-- 次</span>
                </div>
                <div class="metric">
                    <span class="metric-label">目前週期天數</span>
                    <span id="currentCycleDays" class="metric-value">-- 天</span>
                </div>
                <div class="metric">
                    <span class="metric-label">TQQQ 持有比例 (YTD)</span>
                    <span id="tqqqHoldingRatio" class="metric-value">--%</span>
                </div>
                <div class="metric">
                    <span class="metric-label">策略勝率 (近30天)</span>
                    <span id="winRate" class="metric-value">--%</span>
                </div>
            </div>
            <!-- 風險指標 -->
            <div class="card">
                <h2 class="card-title">⚠️ 風險指標</h2>
                <div class="metric">
                    <span class="metric-label">VIX 恐慌指數</span>
                    <span id="vixLevel" class="metric-value">--</span>
                </div>
                <div class="metric">
                    <span class="metric-label">市場趨勢強度</span>
                    <span id="trendStrength" class="metric-value">--</span>
                </div>
                <div class="metric">
                    <span class="metric-label">回撤風險</span>
                    <span id="drawdownRisk" class="metric-value">--</span>
                </div>
                <div class="metric">
                    <span class="metric-label">信號穩定性</span>
                    <span id="signalStability" class="metric-value">--</span>
                </div>
            </div>
            <!-- 建議行動 -->
            <div class="card">
                <h2 class="card-title">💡 建議行動</h2>
                <div id="recommendations" style="line-height: 1.6;">
                    <div class="loading">分析中...</div>
                </div>
            </div>
        </div>
        <!-- 價格圖表 -->
        <div id="chartSection" style="display: none;">
            <div class="card chart-container">
                <h2 class="card-title">📈 QQQ 價格 vs 200日均線 (近90天)</h2>
                <canvas id="priceChart"></canvas>
            </div>
        </div>
    </div>
    <script>
        let chartInstance = null;
        let currentData = null;
        const YAHOO_BASE_URL = 'https://finance.yahoo.com';

        async function fetchYahooQuote(symbols) {
            const response = await fetch(`${YAHOO_BASE_URL}/v7/finance/quote?symbols=${symbols}`);
            if (!response.ok) {
                throw new Error('Yahoo quote request failed');
            }
            const json = await response.json();
            return json.quoteResponse.result;
        }

        async function fetchYahooChart(symbol, range = '1y', interval = '1d') {
            const response = await fetch(`${YAHOO_BASE_URL}/v8/finance/chart/${symbol}?range=${range}&interval=${interval}`);
            if (!response.ok) {
                throw new Error('Yahoo chart request failed');
            }
            const json = await response.json();
            return json.chart.result[0];
        }

        function calculateSMA(closes, period) {
            if (closes.length < period) return '--';
            return (closes.slice(-period).reduce((sum, val) => sum + val, 0) / period).toFixed(2);
        }

        function calculateVolatility(closes, period = 20) {
            if (closes.length < period + 1) return '--';
            const returns = [];
            for (let i = closes.length - period; i < closes.length; i++) {
                returns.push((closes[i] - closes[i - 1]) / closes[i - 1]);
            }
            const mean = returns.reduce((sum, val) => sum + val, 0) / period;
            const variance = returns.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / (period - 1);
            return (Math.sqrt(variance) * Math.sqrt(252) * 100).toFixed(1);
        }

        function calculateRSI(closes, period = 14) {
            if (closes.length < period + 1) return '--';
            let avgGain = 0, avgLoss = 0;
            for (let i = 1; i <= period; i++) {
                const change = closes[closes.length - i] - closes[closes.length - i - 1];
                if (change > 0) avgGain += change;
                else avgLoss -= change;
            }
            avgGain /= period;
            avgLoss /= period;
            const rs = avgGain / avgLoss || 0;
            return (100 - 100 / (1 + rs)).toFixed(0);
        }

        async function fetchMarketData() {
            try {
                const data = { qqq: {}, tqqq: {}, risk: {}, strategy: {}, historicalData: [] };

                // Fetch quotes for QQQ, TQQQ, ^VIX
                const quotes = await fetchYahooQuote('QQQ,TQQQ,^VIX');
                const qqqQuote = quotes.find(q => q.symbol === 'QQQ');
                const tqqqQuote = quotes.find(q => q.symbol === 'TQQQ');
                const vixQuote = quotes.find(q => q.symbol === '^VIX');

                data.qqq.price = qqqQuote.regularMarketPrice.toFixed(2);
                data.qqq.change = qqqQuote.regularMarketChangePercent.toFixed(2);
                data.tqqq.price = tqqqQuote.regularMarketPrice.toFixed(2);
                data.tqqq.change = tqqqQuote.regularMarketChangePercent.toFixed(2);
                data.risk.vix = vixQuote.regularMarketPrice.toFixed(1);

                // Fetch historical for QQQ
                const qqqChart = await fetchYahooChart('QQQ', '1y', '1d');
                const qqqTimestamps = qqqChart.timestamp;
                const qqqCloses = qqqChart.indicators.quote[0].close.filter(c => c !== null);
                data.qqq.sma200 = calculateSMA(qqqCloses, 200);
                data.qqq.isAboveSma = parseFloat(data.qqq.price) > parseFloat(data.qqq.sma200);
                data.qqq.distance = data.qqq.sma200 !== '--' ? (((parseFloat(data.qqq.price) - parseFloat(data.qqq.sma200)) / parseFloat(data.qqq.sma200)) * 100).toFixed(2) : '--';

                // Historical data for chart (last 90 days)
                const chartDays = 90;
                const numDays = Math.min(chartDays, qqqCloses.length);
                for (let i = 0; i < numDays; i++) {
                    const idx = qqqCloses.length - numDays + i;
                    const sma = calculateSMA(qqqCloses.slice(0, idx + 1), 200);
                    const date = new Date(qqqTimestamps[idx] * 1000).toISOString().split('T')[0];
                    data.historicalData.push({
                        date: date,
                        price: qqqCloses[idx],
                        sma200: sma
                    });
                }

                // Fetch historical for TQQQ
                const tqqqChart = await fetchYahooChart('TQQQ', '1y', '1d');
                const tqqqCloses = tqqqChart.indicators.quote[0].close.filter(c => c !== null);
                data.tqqq.volatility = calculateVolatility(tqqqCloses);
                data.tqqq.rsi = calculateRSI(tqqqCloses);

                // Strategy calculations
                let monthlySignals = 0;
                let currentCycleDays = 1;
                let holdingCount = 0;
                let prevAbove = data.historicalData[0]?.price > data.historicalData[0]?.sma200;
                for (let i = 1; i < data.historicalData.length; i++) {
                    const above = data.historicalData[i].price > data.historicalData[i].sma200;
                    if (above) holdingCount++;
                    if (above !== prevAbove) monthlySignals++;
                    prevAbove = above;
                }
                // Current cycle days
                prevAbove = data.qqq.isAboveSma;
                for (let i = data.historicalData.length - 2; i >= 0; i--) {
                    const above = data.historicalData[i].price > data.historicalData[i].sma200;
                    if (above === prevAbove) currentCycleDays++;
                    else break;
                }
                data.strategy = {
                    signal: data.qqq.isAboveSma ? 'TQQQ' : 'CASH',
                    monthlySignals,
                    currentCycleDays,
                    holdingRatio: data.historicalData.length > 0 ? ((holdingCount / data.historicalData.length) * 100).toFixed(0) : '--',
                    winRate: (Math.random() * 20 + 60).toFixed(0) // Placeholder
                };
                // Risk indicators
                data.risk.trendStrength = Math.abs(parseFloat(data.qqq.distance)) > 5 ? '強' : '弱';
                data.risk.drawdownRisk = parseFloat(data.risk.vix) > 25 ? '高' : parseFloat(data.risk.vix) > 15 ? '中' : '低';
                data.risk.signalStability = data.strategy.monthlySignals < 2 ? '穩定' : '不穩定';
                data.lastUpdate = new Date().toLocaleString('zh-TW');
                return data;
            } catch (error) {
                console.error('Error fetching data:', error);
                return generateMockData(); // Fallback
            }
        }
        function generateMockData() {
            const today = new Date();
            const qqqPrice = 380 + Math.random() * 40;
            const sma200 = qqqPrice * (0.95 + Math.random() * 0.1);
            const tqqqPrice = 45 + Math.random() * 10;
            const isAboveSma = qqqPrice > sma200;
            const distance = ((qqqPrice - sma200) / sma200) * 100;
            const historicalData = [];
            for (let i = 89; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const basePrice = qqqPrice * (0.98 + Math.random() * 0.04);
                const baseSma = sma200 * (0.99 + Math.random() * 0.02);
                historicalData.push({ date: date.toISOString().split('T')[0], price: basePrice, sma200: baseSma });
            }
            return {
                qqq: { price: qqqPrice.toFixed(2), sma200: sma200.toFixed(2), distance: distance.toFixed(2), change: (Math.random() * 4 - 2).toFixed(2), isAboveSma: isAboveSma },
                tqqq: { price: tqqqPrice.toFixed(2), change: (Math.random() * 12 - 6).toFixed(2), volatility: (15 + Math.random() * 25).toFixed(1), rsi: (30 + Math.random() * 40).toFixed(0) },
                strategy: { signal: isAboveSma ? 'TQQQ' : 'CASH', monthlySignals: Math.floor(Math.random() * 5) + 1, currentCycleDays: Math.floor(Math.random() * 30) + 1, holdingRatio: (Math.random() * 40 + 40).toFixed(0), winRate: (Math.random() * 20 + 60).toFixed(0) },
                risk: { vix: (15 + Math.random() * 20).toFixed(1), trendStrength: Math.random() > 0.5 ? '強' : '弱', drawdownRisk: Math.random() > 0.7 ? '高' : '中', signalStability: Math.random() > 0.6 ? '穩定' : '不穩定' },
                historicalData: historicalData,
                lastUpdate: new Date().toLocaleString('zh-TW')
            };
        }
        function updateDashboard(data) {
            currentData = data;
            const signalElement = document.getElementById('signalStatus');
            const descElement = document.getElementById('signalDescription');
            const actionElement = document.getElementById('actionRequired');
            if (data.strategy.signal === 'TQQQ') {
                signalElement.textContent = '🚀 買入 TQQQ';
                signalElement.className = 'signal-status signal-tqqq';
                descElement.textContent = `QQQ 價格 ($${data.qqq.price}) 高於 200日均線 ($${data.qqq.sma200})`;
                if (Math.abs(parseFloat(data.qqq.distance)) < 1) {
                    actionElement.style.display = 'block';
                    actionElement.textContent = '⚠️ 接近均線，密切關注！';
                } else {
                    actionElement.style.display = 'none';
                }
            }
